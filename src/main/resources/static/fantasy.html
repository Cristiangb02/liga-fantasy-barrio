<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Liga Barrio Fantasy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f0f2f5; padding: 10px; margin: 0 auto; color: #333; max-width: 1000px; }
        
        header { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #1a237e, #0d47a1); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .jornada-badge { background: #ffd600; color: #333; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-left: 10px; }
        .presupuesto-box { font-size: 1rem; font-weight: bold; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; white-space: nowrap;}
        .presupuesto-negativo { background: #d32f2f; color: white; }
        .btn-logout { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; }

        nav { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        nav button { flex: 0 0 auto; padding: 10px 15px; border: none; background: white; cursor: pointer; border-radius: 8px; font-weight: 700; color: #546e7a; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; font-size: 0.9em; }
        nav button.active { background: #1a237e; color: white; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(26, 35, 126, 0.3); }
        nav button.admin-tab { background: #ffebee !important; color: #b71c1c !important; }
        nav button.admin-tab.active { background: #d32f2f !important; color: white !important; }

        /* --- üî¥ NUEVO DISE√ëO DE CARTAS (PUNTO 8) --- */
        .grid-jugadores { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        
        .card { 
            background: white; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            position: relative; 
            display: flex; 
            flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        /* Alineado: Borde verde brillante */
        .card.alineado { 
            border: 3px solid #2e7d32; 
            box-shadow: 0 0 10px rgba(46, 125, 50, 0.3);
        }

        /* üî¥ TRI√ÅNGULO DE PUNTOS (PUNTO 8) */
        .puntos-triangle {
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 55px 55px 0;
            border-color: transparent #2e7d32 transparent transparent; /* Tri√°ngulo verde */
            z-index: 2;
        }
        .puntos-val {
            position: absolute;
            top: 6px;
            right: 7px;
            color: white;
            font-weight: 800;
            font-size: 0.9rem;
            z-index: 3;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* IMAGEN Y CONTENIDO */
        .card-img-container { 
            height: 140px; 
            background: linear-gradient(to top, #cfd8dc, #eceff1); /* Degradado suave fondo */
            display: flex; 
            justify-content: center; 
            align-items: flex-end; 
            overflow: hidden;
            position: relative;
        }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .card:hover .card-img { transform: scale(1.05); }

        .card-body { padding: 10px; text-align: center; display: flex; flex-direction: column; gap: 6px; flex-grow: 1; }
        .card-name { font-weight: 700; font-size: 0.95em; color: #1a237e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-pos-badge { 
            display: inline-block; 
            background: #eceff1; 
            color: #546e7a; 
            font-size: 0.7em; 
            font-weight: 800; 
            padding: 2px 8px; 
            border-radius: 10px; 
            text-transform: uppercase;
            align-self: center;
        }
        .card-clausula { font-size: 0.8em; color: #d32f2f; font-weight: bold; }

        /* BOTONES */
        .btn-card { width: 100%; padding: 8px; border: none; border-radius: 6px; font-weight: 700; font-size: 0.85em; cursor: pointer; margin-top: auto; transition: 0.2s; }
        .btn-card:active { transform: scale(0.95); }
        .btn-fichar { background: #0288d1; color: white; }
        .btn-robar { background: #d32f2f; color: white; }
        .btn-vender { background: #ff8f00; color: white; }
        .btn-blindar { background: #388e3c; color: white; }
        
        .alineacion-overlay { position: absolute; top: 8px; left: 8px; z-index: 10; }
        .check-alinear { transform: scale(1.5); cursor: pointer; accent-color: #2e7d32; }

        .btn-action-big { background: #2e7d32; color: white; margin-top: 15px; padding: 14px; width: 100%; border-radius: 8px; border:none; font-size: 1.1em; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #1b5e20; }
        
        /* UTILIDADES */
        .oculto { display: none !important; }
        .seccion { min-height: 400px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        
        .fila-clasif { background: white; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #1a237e; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .pos-num { font-size: 1.2em; font-weight: 900; color: #1a237e; min-width: 30px; }
        .user-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; margin-bottom: 5px; border-radius: 5px; border: 1px solid #eee; }
        .noticia-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #1a237e; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9em; animation: fadeIn 0.5s; }
        .btn-delete-user { background: #e53935; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: bold; }

        /* MODAL */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 1000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.2s; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; }
        .modal-titulo { margin-top: 0; color: #1565c0; font-size: 1.2rem; }
        .modal-mensaje { color: #555; margin-bottom: 20px; font-size: 0.95em; line-height: 1.5; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; margin-bottom: 10px; box-sizing: border-box; }
        .modal-info-extra { background: #f5f5f5; padding: 10px; border-radius: 6px; font-size: 0.85em; color: #333; margin-bottom: 20px; text-align: left; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-modal { padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-modal-cancel { background: #cfd8dc; color: #455a64; }
        .btn-modal-ok { background: #1565c0; color: white; }
        .btn-modal-danger { background: #d32f2f; color: white; }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; flex-direction:column;">
            <div style="display:flex; align-items:center;">
                <h1 id="titulo-web">Fantasy</h1>
                <span id="badge-jornada" class="jornada-badge">J-</span>
            </div>
            <span style="font-size:0.75em; opacity:0.8;">Manager 2025</span>
        </div>
        <div style="display:flex; align-items:center; gap: 10px;">
            <div id="presupuesto-display" class="presupuesto-box">0 ‚Ç¨</div>
            <button class="btn-logout" onclick="logout()">Salir</button>
        </div>
    </header>

    <nav>
        <button onclick="cambiarPesta√±a('plantilla')" id="tab-plantilla" class="active">üë• Plantilla</button>
        <button onclick="cambiarPesta√±a('alineacion')" id="tab-alineacion">‚öΩ Once</button>
        <button onclick="cambiarPesta√±a('mercado')" id="tab-mercado">üõí Mercado</button>
        <button onclick="cambiarPesta√±a('rivales')" id="tab-rivales">üïµÔ∏è Rivales</button>
        <button onclick="cambiarPesta√±a('clasificacion')" id="tab-clasificacion">üèÜ Tabla</button>
        <button onclick="cambiarPesta√±a('noticias')" id="tab-noticias">üì∞ Noticias</button>
        <button onclick="cambiarPesta√±a('admin')" id="tab-admin" class="admin-tab oculto">ADMIN</button>
    </nav>

    <div id="sec-plantilla" class="seccion">
        <h3>Tu Plantilla</h3>
        <div id="grid-mi-plantilla" class="grid-jugadores">Cargando...</div>
    </div>

    <div id="sec-alineacion" class="seccion oculto">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>Alineaci√≥n <span style="font-size:0.7em; color:#1565c0;">(Jornada <span id="num-jornada-alineacion"></span>)</span></h3>
            <span style="background:#e3f2fd; padding:3px 10px; border-radius:15px; color:#0d47a1; font-weight:bold; font-size:0.9em;">
                <span id="contador-alineados">0</span>/8
            </span>
        </div>
        <p style="font-size:0.8em; color:#d32f2f;" id="aviso-saldo">‚ö†Ô∏è Si tu saldo es negativo, har√°s 0 puntos.</p>
        <div id="grid-alineacion" class="grid-jugadores">Cargando...</div>
        <button class="btn-action-big" onclick="guardarAlineacion()">üíæ GUARDAR</button>
    </div>

    <div id="sec-mercado" class="seccion oculto">
        <h3>Mercado Libre</h3>
        <div id="grid-mercado" class="grid-jugadores">Cargando...</div>
    </div>

    <div id="sec-rivales" class="seccion oculto">
        <h3>Managers</h3>
        <div id="lista-rivales" style="display:flex; flex-direction:column; gap:8px;">Cargando...</div>
        <div id="zona-espia" class="oculto" style="margin-top:20px; border-top:2px dashed #ccc; padding-top:15px;">
            <h4 id="titulo-espia">Ojeando...</h4>
            <div id="grid-rival" class="grid-jugadores"></div>
        </div>
    </div>

    <div id="sec-clasificacion" class="seccion oculto">
        <h3>Clasificaci√≥n</h3>
        <div id="lista-clasificacion">Cargando...</div>
    </div>

    <div id="sec-noticias" class="seccion oculto">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Noticias</h3>
            <small style="color:#666">En vivo üî¥</small>
        </div>
        <div id="lista-noticias">Cargando...</div>
    </div>

    <div id="sec-admin" class="seccion oculto">
        <h3 style="color:#c62828">Panel Admin</h3>
        <div style="background:white; padding:15px; border-radius:10px; border:1px solid #ffcdd2; margin-bottom: 20px;">
            <h4>üìù Gestionar Partidos</h4>
            <select id="admin-jugador" style="width:100%; padding:10px; margin-bottom:15px; border-radius:5px;"><option>Cargando...</option></select>
            <div style="display:flex; gap:20px; margin-bottom:15px;">
                <label><input type="checkbox" id="check-victoria"> Gan√≥</label>
                <label><input type="checkbox" id="check-derrota"> Perdi√≥</label>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="number" id="input-goles" placeholder="Goles" style="padding:8px; flex:1;">
                <input type="number" id="input-encajados" placeholder="Encajados" style="padding:8px; flex:1;">
            </div>
            <button onclick="registrarActa()" style="background:#c62828; color:white; width:100%; padding:12px; border:none; border-radius:5px; font-weight:bold; margin-bottom:10px;">Registrar Puntos</button>
            <button onclick="cerrarJornada()" style="background:#37474f; color:white; width:100%; padding:12px; border:none; border-radius:5px; font-weight:bold;">üîÑ CERRAR JORNADA</button>
        </div>
        <div style="background:white; padding:15px; border-radius:10px; border:1px solid #90caf9; margin-bottom: 20px;">
            <h4>üëÆ Gesti√≥n Usuarios</h4>
            <div id="admin-lista-usuarios">Cargando...</div>
        </div>
        <div style="background:#ffebee; padding:15px; border-radius:10px; border:2px dashed #c62828;">
            <h4 style="color:#b71c1c; margin-top:0;">‚ò¢Ô∏è ZONA DE PELIGRO</h4>
            <button onclick="resetearLiga()" style="background:#d32f2f; color:white; width:100%; padding:15px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">‚ö†Ô∏è RESETEAR LIGA COMPLETA</button>
        </div>
    </div>

    <div id="modal-overlay" class="oculto">
        <div class="modal-box">
            <h3 id="modal-titulo" class="modal-titulo">T√≠tulo</h3>
            <p id="modal-mensaje" class="modal-mensaje">Mensaje...</p>
            <div id="modal-input-container" class="oculto">
                <input type="text" id="modal-input" class="modal-input" placeholder="Escribe aqu√≠...">
                <div id="modal-info-extra" class="modal-info-extra oculto"></div>
            </div>
            <div class="modal-buttons">
                <button id="btn-modal-cancel" class="btn-modal btn-modal-cancel">Cancelar</button>
                <button id="btn-modal-ok" class="btn-modal btn-modal-ok">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        const usuarioId = localStorage.getItem('usuarioId');
        const esAdmin = (localStorage.getItem('esAdmin') === 'true');
        let presupuesto = parseInt(localStorage.getItem('presupuesto') || 0);
        const formatoDinero = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });

        let modalCallback = null;
        function mostrarModal(titulo, mensaje, tipo, callback) {
            document.getElementById('modal-titulo').innerText = titulo;
            document.getElementById('modal-mensaje').innerText = mensaje;
            document.getElementById('modal-overlay').classList.remove('oculto');
            const btnOk = document.getElementById('btn-modal-ok');
            const inputContainer = document.getElementById('modal-input-container');
            const input = document.getElementById('modal-input');
            const infoExtra = document.getElementById('modal-info-extra');
            input.value = '';
            inputContainer.classList.add('oculto');
            infoExtra.classList.add('oculto');
            btnOk.className = 'btn-modal btn-modal-ok'; 

            if (tipo === 'input' || tipo === 'blindar') {
                inputContainer.classList.remove('oculto');
                input.placeholder = tipo === 'blindar' ? "Cantidad a invertir (sin puntos)" : "Escribe...";
                if(tipo === 'blindar') {
                    input.onkeyup = function() {
                        let val = parseInt(this.value);
                        if(!isNaN(val) && val > 0) {
                            infoExtra.classList.remove('oculto');
                            infoExtra.innerHTML = `<strong>Coste:</strong> ${formatoDinero.format(val)}<br><strong>Subida Cl√°usula:</strong> ${formatoDinero.format(val*2)}`;
                        } else { infoExtra.classList.add('oculto'); }
                    }
                } else { input.onkeyup = null; }
            } else if (tipo === 'danger') {
                inputContainer.classList.remove('oculto');
                input.placeholder = "Escribe RESET para confirmar";
                btnOk.className = 'btn-modal btn-modal-danger';
            }
            modalCallback = () => {
                if (tipo === 'confirm') callback();
                else if (tipo === 'input' || tipo === 'blindar' || tipo === 'danger') callback(input.value);
                cerrarModal();
            };
        }
        function cerrarModal() { document.getElementById('modal-overlay').classList.add('oculto'); modalCallback = null; }
        document.getElementById('btn-modal-ok').onclick = () => { if(modalCallback) modalCallback(); };
        document.getElementById('btn-modal-cancel').onclick = cerrarModal;

        if (!usuarioId) window.location.href = 'login.html';

        window.onload = function() {
            document.getElementById('titulo-web').innerText = localStorage.getItem('usuarioNombre');
            actualizarPresupuestoUI();
            if (esAdmin) {
                document.getElementById('tab-admin').classList.remove('oculto');
                cargarUsuariosAdmin();
            }
            cargarTodo();
            setInterval(cargarNoticias, 5000); 
        };

        function cargarTodo() {
            fetch('/jornada/actual').then(r=>r.json()).then(n => {
                document.getElementById('badge-jornada').innerText = "J-" + n;
                document.getElementById('num-jornada-alineacion').innerText = n;
            });

            fetch('/jugadores').then(r=>r.json()).then(jugadores => {
                window.todosLosJugadores = jugadores;
                pintarPlantilla(jugadores);
                pintarMercado(jugadores);
                if(esAdmin) pintarSelectAdmin(jugadores);
                fetch(`/alineacion/${usuarioId}`).then(r => r.json()).then(alineados => {
                    const idsAlineados = new Set(alineados.map(a => a.id));
                    pintarAlineacion(jugadores, idsAlineados);
                });
            });
            fetch('/usuarios').then(r=>r.json()).then(usuarios => pintarRivales(usuarios));
            fetch('/clasificacion').then(r=>r.json()).then(data => {
                let html = data.map((fila, i) => `
                    <div class="fila-clasif">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span class="pos-num">${i+1}¬∫</span>
                            <strong>${fila.nombre}</strong>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:bold; color:#1565c0;">${fila.puntos} pts</div>
                            <div style="font-size:0.85em; color:#666;">üí∞ ${formatoDinero.format(fila.valorPlantilla)}</div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('lista-clasificacion').innerHTML = html;
            });
            cargarNoticias();
        }

        function cargarNoticias() {
            fetch('/noticias').then(r=>r.json()).then(noticias => {
                let html = noticias.map(n => `<div class="noticia-item ${n.mensaje.includes("CL√ÅUSULAZO") || n.mensaje.includes("ADMIN") ? 'noticia-robo':''}"><span class="noticia-fecha">${n.fechaBonita}</span><span class="noticia-texto">${n.mensaje}</span></div>`).join('');
                const container = document.getElementById('lista-noticias');
                if (container.innerHTML !== html) container.innerHTML = html || '<p>No hay noticias.</p>';
            });
        }

        function cargarUsuariosAdmin() {
            fetch('/usuarios').then(r => r.json()).then(usuarios => {
                document.getElementById('admin-lista-usuarios').innerHTML = usuarios.map(u => `
                    <div class="user-row"><span>${u.nombre} ${u.esAdmin ? '(ADMIN)' : ''}</span>${!u.esAdmin ? `<button class="btn-delete-user" onclick="expulsarUsuario(${u.id}, '${u.nombre}')">Expulsar</button>` : ''}</div>
                `).join('');
            });
        }

        // --- üî¥ RENDERIZADO DE CARTAS (NUEVO DISE√ëO) ---
        function crearCarta(j, tipo, alineado = false) {
            let img = j.urlImagen && j.urlImagen.startsWith('/') ? j.urlImagen : (j.urlImagen || 'https://via.placeholder.com/150');
            let precio = formatoDinero.format(j.valor);
            let clausula = formatoDinero.format(j.clausula);
            
            let contenido = '';
            let extraClass = alineado ? 'alineado' : '';
            let checked = alineado ? 'checked' : '';

            // L√≥gica de botones
            if (tipo === 'alinear') contenido = `<div class="alineacion-overlay"><input type="checkbox" class="check-alinear" value="${j.id}" ${checked} onclick="actualizarContador(this)"></div>`;
            else if (tipo === 'fichar') contenido = `<button class="btn-card btn-fichar" onclick="fichar(${j.id}, ${j.valor})">Fichar (${precio})</button>`;
            else if (tipo === 'robar') contenido = `<button class="btn-card btn-robar" onclick="robar(${j.id}, ${j.clausula})">üî• ${clausula}</button>`;
            else if (tipo === 'gestion') {
                contenido = `
                    <div style="display:flex; gap:5px; margin-top:auto;">
                        <button class="btn-card btn-vender" style="flex:1" onclick="vender(${j.id}, ${j.valor}, ${j.clausula})">Vender</button>
                        <button class="btn-card btn-blindar" style="flex:1" onclick="blindar(${j.id})">üîí Subir</button>
                    </div>`;
            }

            // HTML Estructura Nueva
            return `
                <div class="card ${extraClass}" id="card-${j.id}">
                    <div class="puntos-triangle"></div>
                    <div class="puntos-val">${j.puntosAcumulados}</div>
                    
                    ${tipo === 'alinear' ? contenido : ''} <div class="card-img-container"><img src="${img}" class="card-img"></div>
                    
                    <div class="card-body">
                        <div class="card-name">${j.nombre}</div>
                        <div class="card-pos-badge">${j.posicion}</div>
                        ${tipo === 'gestion' ? `<div class="card-clausula">Cl√°usula: ${clausula}</div>` : ''}
                        ${tipo !== 'alinear' ? contenido : ''}
                    </div>
                </div>`;
        }

        function pintarPlantilla(jugadores) { document.getElementById('grid-mi-plantilla').innerHTML = jugadores.filter(j => j.propietario && j.propietario.id == usuarioId).map(j => crearCarta(j, 'gestion')).join('') || '<p>Sin jugadores.</p>'; }
        function pintarAlineacion(jugadores, idsAlineados) { 
            const misJugadores = jugadores.filter(j => j.propietario && j.propietario.id == usuarioId);
            misJugadores.sort((a, b) => {
                const aAlineado = idsAlineados.has(a.id) ? 1 : 0;
                const bAlineado = idsAlineados.has(b.id) ? 1 : 0;
                return bAlineado - aAlineado;
            });
            document.getElementById('grid-alineacion').innerHTML = misJugadores.map(j => crearCarta(j, 'alinear', idsAlineados.has(j.id))).join('') || '<p>Sin jugadores.</p>'; 
            actualizarContador(); 
        }
        function pintarMercado(jugadores) { document.getElementById('grid-mercado').innerHTML = jugadores.filter(j => !j.propietario).map(j => crearCarta(j, 'fichar')).join('') || '<p>Mercado vac√≠o.</p>'; }
        function pintarRivales(usuarios) { document.getElementById('lista-rivales').innerHTML = usuarios.filter(u => u.id != usuarioId).map(u => `<div style="background:white; padding:15px; border-radius:8px; cursor:pointer; font-weight:bold; display:flex; justify-content:space-between;" onclick="espiar(${u.id}, '${u.nombre}')"><span>‚öΩ ${u.nombre}</span> <span>üîç</span></div>`).join(''); }
        
        function espiar(id, nombre) {
            document.getElementById('zona-espia').classList.remove('oculto');
            document.getElementById('titulo-espia').innerText = "Equipo de " + nombre;
            document.getElementById('grid-rival').innerHTML = window.todosLosJugadores.filter(j => j.propietario && j.propietario.id == id).map(j => crearCarta(j, 'robar')).join('') || '<p>Sin jugadores.</p>';
        }

        function actualizarContador(checkbox) {
            if(checkbox) {
                const card = document.getElementById('card-' + checkbox.value);
                if(checkbox.checked) card.classList.add('alineado'); else card.classList.remove('alineado');
            }
            const count = document.querySelectorAll('.check-alinear:checked').length;
            const badge = document.getElementById('contador-alineados');
            badge.innerText = count;
            badge.style.color = count > 8 ? 'red' : 'white';
        }

        function fichar(id, p) { mostrarModal("Fichar Jugador", `¬øFichar por ${formatoDinero.format(p)}?`, 'confirm', () => post(`/mercado/comprar/${id}/${usuarioId}`, {}, p)); }
        function robar(id, p) { mostrarModal("Clausulazo üî•", `¬øPagar cl√°usula de ${formatoDinero.format(p)}?`, 'confirm', () => post(`/mercado/robar/${id}/${usuarioId}`, {}, p)); }
        function vender(id, valor, clausula) {
            let ingreso = valor + (clausula - valor) / 2;
            mostrarModal("Vender al Mercado", `Recuperar√°s Coste + Inversi√≥n.\n\nüí∞ Recibir√°s: ${formatoDinero.format(ingreso)}\n\n¬øConfirmar venta?`, 'confirm', () => post(`/mercado/vender/${id}/${usuarioId}`, {}, -ingreso));
        }
        function blindar(id) { mostrarModal("Subir Cl√°usula üîí", "Introduce cantidad a invertir.", 'blindar', (cant) => { if (cant && !isNaN(cant) && cant > 0) post(`/jugador/subir-clausula/${id}/${cant}`, {}, cant); }); }
        function expulsarUsuario(id, nombre) { mostrarModal("Expulsar", `¬øEchar a ${nombre}?`, 'confirm', () => { fetch(`/admin/eliminar-usuario/${id}`, { method: 'DELETE' }).then(r=>r.text()).then(msg => { mostrarModal("Info", msg, 'confirm', ()=>{ cargarUsuariosAdmin(); cargarTodo(); }); }); }); }
        function resetearLiga() { mostrarModal("‚ö†Ô∏è PELIGRO: RESET", "Escribe RESET para borrar todo:", 'danger', (t) => { if(t==="RESET") post('/admin/reset-liga', {}); else mostrarModal("Error","C√≥digo mal.",'confirm',()=>{}); }); }
        
        function guardarAlineacion() {
            const ids = Array.from(document.querySelectorAll('.check-alinear:checked')).map(cb => parseInt(cb.value));
            if(ids.length > 8) { mostrarModal("Alineaci√≥n", "M√°ximo 8 jugadores.", 'confirm', ()=>{}); return; }
            post(`/alinear/${usuarioId}`, ids);
        }

        function post(url, data, coste = 0) {
            if(coste > 0 && coste > presupuesto) { mostrarModal("Error", "No tienes dinero.", 'confirm', ()=>{}); return; }
            fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) })
            .then(r => r.text()).then(msg => {
                mostrarModal("Informaci√≥n", msg, 'confirm', () => {
                    if(!msg.includes("‚ùå")) {
                        if(coste !== 0) { presupuesto -= coste; localStorage.setItem('presupuesto', presupuesto); actualizarPresupuestoUI(); }
                        cargarTodo();
                    }
                });
            });
        }

        function pintarSelectAdmin(jugadores) { document.getElementById('admin-jugador').innerHTML = jugadores.map(j => `<option value="${j.id}">${j.nombre}</option>`).join(''); }
        function registrarActa() { const datos = { idJugador: parseInt(document.getElementById('admin-jugador').value), idJornada: 1, victoria: document.getElementById('check-victoria').checked, derrota: document.getElementById('check-derrota').checked, goles: parseInt(document.getElementById('input-goles').value)||0, golesEncajados: parseInt(document.getElementById('input-encajados').value)||0, autogoles: 0 }; post('/admin/registrar', datos); }
        function cerrarJornada() { mostrarModal("Cerrar Jornada", "¬øRepartir puntos y dinero?", 'confirm', () => post('/admin/cerrar-jornada', {})); }

        function cambiarPesta√±a(tab) { document.querySelectorAll('.seccion').forEach(s => s.classList.add('oculto')); document.querySelectorAll('nav button').forEach(b => b.classList.remove('active')); document.getElementById('sec-' + tab).classList.remove('oculto'); document.getElementById('tab-' + tab).classList.add('active'); }
        function actualizarPresupuestoUI() { const el = document.getElementById('presupuesto-display'); el.innerText = formatoDinero.format(presupuesto); if(presupuesto < 0) { el.classList.add('presupuesto-negativo'); document.getElementById('aviso-saldo').classList.remove('oculto'); } else { el.classList.remove('presupuesto-negativo'); document.getElementById('aviso-saldo').classList.add('oculto'); } }
        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
    </script>
</body>
</html>
