<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Liga Barrio Fantasy</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a237e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="icon" type="image/png" href="/icon.png">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f0f2f5; padding: 10px; margin: 0 auto; color: #333; max-width: 1000px; }

        header {
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #1a237e, #0d47a1);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%; /* Ocupa todo para manejar el layout interno */
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 10px;
            flex-shrink: 0;
            transition: 0.2s;
        }

        .btn-logout:hover {
            background: #d32f2f;
            border-color: #d32f2f;
        }

        .avatar-header {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e0e0e0;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:1.8rem;
            border: 2px solid white;
            flex-shrink: 0;
        }

        .user-details-col {
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
        }

        .user-name-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #titulo-web {
            margin: 0;
            font-size: 1.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .jornada-badge { background: #ffd600; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; flex-shrink: 0; }

        .presupuesto-box {
            font-size: 0.95rem;
            font-weight: bold;
            color: #b3e5fc;
            margin-top: 2px;
        }
        .presupuesto-negativo { color: #ff8a80 !important; }

        nav { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        nav button { position: relative; flex: 0 0 auto; padding: 10px 15px; border: none; background: white; cursor: pointer; border-radius: 8px; font-weight: 700; color: #546e7a; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s; font-size: 0.9em; }
        nav button.active { background: #1a237e; color: white; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(26, 35, 126, 0.3); }
        nav button.admin-tab { background: #ffebee !important; color: #b71c1c !important; }
        nav button.admin-tab.active { background: #d32f2f !important; color: white !important; }

        .notif-badge { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: #d32f2f; border-radius: 50%; border: 2px solid white; display: none; }
        .notif-active .notif-badge { display: block; }

        .btn-partido { background: #2e7d32 !important; color: white !important; }

        .grid-jugadores { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }

        .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); position: relative; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.05); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .card.alineado { border: 3px solid #2e7d32; box-shadow: 0 0 10px rgba(46, 125, 50, 0.3); }

        .puntos-triangle { position: absolute; top: 0; right: 0; width: 0; height: 0; border-style: solid; border-width: 0 55px 55px 0; z-index: 2; }
        .triangle-pos { border-color: transparent #2e7d32 transparent transparent; }
        .triangle-neu { border-color: transparent #ff9800 transparent transparent; }
        .triangle-neg { border-color: transparent #d32f2f transparent transparent; }

        .puntos-val { position: absolute; top: 6px; right: 7px; color: white; font-weight: 800; font-size: 0.9rem; z-index: 3; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }

        .card-img-container { height: 140px; background: linear-gradient(to top, #cfd8dc, #eceff1); display: flex; justify-content: center; align-items: flex-end; overflow: hidden; position: relative; cursor: pointer; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .card:hover .card-img { transform: scale(1.05); }

        .blindado-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 5; font-weight: bold; text-align: center; }
        .candado-icon { font-size: 2rem; margin-bottom: 5px; }
        .timer-blindaje { font-family: monospace; font-size: 1.1em; color: #ffeb3b; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        .card-body { padding: 10px; text-align: center; display: flex; flex-direction: column; gap: 6px; flex-grow: 1; cursor: pointer; }
        .card-name { font-weight: 700; font-size: 0.95em; color: #1a237e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .card-pos-badge { display: inline-block; font-size: 0.75em; font-weight: 900; padding: 4px 10px; border-radius: 12px; text-transform: uppercase; align-self: center; color: white; letter-spacing: 0.5px; margin-top: 2px; }
        .pos-portero { background-color: #7b1fa2; } /* Morado */
        .pos-defensa { background-color: #d32f2f; } /* Rojo */
        .pos-medio { background-color: #f57c00; }   /* Naranja */
        .pos-delantero { background-color: #388e3c; } /* Verde */

        .card-clausula { font-size: 0.8em; color: #d32f2f; font-weight: bold; }
        .card-coste { font-size: 0.85em; color: #1565c0; font-weight: 800; }

        .btn-card { width: 100%; padding: 8px; border: none; border-radius: 6px; font-weight: 700; font-size: 0.85em; cursor: pointer; margin-top: auto; transition: 0.2s; }
        .btn-card:active { transform: scale(0.95); }
        .btn-fichar { background: #0288d1; color: white; }
        .btn-robar { background: #d32f2f; color: white; }
        .btn-ofertar { background: #7b1fa2; color: white; margin-top: 5px; }
        .btn-vender { background: #d32f2f; color: white; }
        .btn-blindar { background: #388e3c; color: white; }
        .btn-action-big { background: #2e7d32; color: white; margin-top: 15px; padding: 14px; width: 100%; border-radius: 8px; border:none; font-size: 1.1em; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #1b5e20; }
        .alineacion-overlay { position: absolute; top: 8px; left: 8px; z-index: 10; }
        .check-alinear { transform: scale(1.5); cursor: pointer; accent-color: #2e7d32; }
        .oculto { display: none !important; }
        .seccion { min-height: 400px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        .fila-clasif { background: white; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #1a237e; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .pos-num { font-size: 1.2em; font-weight: 900; color: #1a237e; min-width: 30px; }
        .avatar-small { width: 36px; height: 36px; min-width: 36px; border-radius: 50%; background-color: #e0e0e0; border: 2px solid #e3e8ee; display:flex; align-items:center; justify-content:center; overflow:hidden;}
        .avatar-small img { width:100%; height:100%; object-fit:cover; }
        .clasif-user { display: flex; align-items: center; gap: 12px; }
        .user-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; margin-bottom: 5px; border-radius: 5px; border: 1px solid #eee; }
        .noticia-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #1a237e; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9em; animation: fadeIn 0.5s; }
        .btn-delete-user { background: #e53935; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: bold; }
        .btn-edit-user { background: #0288d1; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; font-weight: bold; margin-right: 5px; }
        .market-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #fff; padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .timer-badge { background: #1a237e; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-family: monospace; font-size: 1.1em; letter-spacing: 1px; }
        .bloque-premios { background: #e8f5e9; border: 1px solid #43a047; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-reclamar { background: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 125, 50, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(46, 125, 50, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 125, 50, 0); } }

        .historial-card { background: white; margin-bottom: 15px; border-radius: 10px; border-left: 5px solid #546e7a; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
        .historial-header { padding: 12px 15px; background: #eceff1; font-weight: bold; display: flex; justify-content: space-between; align-items: center; color: #37474f; }
        .historial-badge { background: #37474f; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.9em; }
        .historial-body { padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; }
        .player-mini { background: #fff; border: 1px solid #ddd; padding: 8px; border-radius: 5px; font-size: 0.85em; display:flex; flex-direction:column; gap:4px; }
        .mini-puntos { font-weight:bold; font-size:1.1em; align-self: flex-end; }
        .mini-pos { font-size: 0.8em; opacity: 0.7; }
        .text-green { color: #2e7d32; }
        .text-red { color: #d32f2f; }
        .text-orange { color: #ff9800; }

        .oferta-item { background: #fff; border: 1px solid #ddd; border-left: 5px solid #7b1fa2; padding: 10px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .oferta-item.enviada { border-left: 5px solid #0288d1; background: #e1f5fe; } /* Estilo diferente para enviadas */
        .oferta-info { font-size: 0.9em; }
        .btn-oferta-ok { background: #2e7d32; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 5px; }
        .btn-oferta-ko { background: #d32f2f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        .solicitud-row { display: flex; justify-content: space-between; align-items: center; background: #fffde7; border: 1px solid #fbc02d; padding: 10px; margin-bottom: 5px; border-radius: 5px; }
        .btn-aprobar { background: #43a047; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 5px; }
        .btn-rechazar { background: #d32f2f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        .modal-jugador-img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #1a237e; margin-bottom: 15px; display: block; margin-left: auto; margin-right: auto; }
        .detalle-stats { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
        .stat-row { display: flex; justify-content: space-between; padding: 10px; background: #f5f5f5; border-radius: 6px; align-items: center; font-weight: bold; }
        .badge-puntos { padding: 4px 10px; border-radius: 15px; color: white; font-size: 0.9em; min-width: 30px; text-align: center; }
        .bg-green { background: #2e7d32; }
        .bg-orange { background: #ff9800; color: #333; }
        .bg-red { background: #d32f2f; }

        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 1000; display: flex; justify-content: center; align-items: center; animation: fadeIn 0.2s; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; max-height: 80vh; overflow-y: auto; }
        .modal-titulo { margin-top: 0; color: #1565c0; font-size: 1.2rem; }
        .modal-mensaje { color: #555; margin-bottom: 20px; font-size: 0.95em; line-height: 1.5; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; margin-bottom: 10px; box-sizing: border-box; }
        .modal-info-extra { background: #f5f5f5; padding: 10px; border-radius: 6px; font-size: 0.85em; color: #333; margin-bottom: 20px; text-align: left; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .btn-modal { padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-modal-cancel { background: #cfd8dc; color: #455a64; }
        .btn-modal-ok { background: #1565c0; color: white; }
        .btn-modal-danger { background: #d32f2f; color: white; }

        .fila-ranking {
            background: white; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .fila-ranking:hover { transform: scale(1.02); }
        .fila-ranking.top-1 { border-left: 5px solid #FFD700; background: linear-gradient(to right, #fff, #fffde7); }
        .fila-ranking.top-2 { border-left: 5px solid #C0C0C0; }
        .fila-ranking.top-3 { border-left: 5px solid #CD7F32; }

        .ranking-medal { font-size: 1.2em; min-width: 30px; }
        .ranking-details { display:flex; align-items:center; gap:10px; }
        .ranking-points { font-weight:900; color:#1a237e; font-size:1.1em; }

        .timer-mini { font-size: 0.8em; color: #e65100; font-weight: bold; background: #fff3e0; padding: 2px 5px; border-radius: 4px;
        margin-bottom: 5px; display: inline-block; border: 1px solid #ffb74d; }

        .btn-back-red { background: #d32f2f; border: 1px solid #b71c1c; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: bold; }

        .online-bar {
            background: #e3f2fd;
            color: #1565c0;
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            border: 1px solid #bbdefb;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .online-dot { height: 8px; width: 8px; background-color: #4caf50; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #4caf50; }
    </style>
</head>
<body>

<header>
    <div class="user-info">
        <div class="avatar-header">üë§</div>
        <div class="user-details-col">
            <div class="user-name-row">
                <h1 id="titulo-web">Fantasy</h1>
                <span id="badge-jornada" class="jornada-badge">J-</span>
            </div>
            <div id="presupuesto-display" class="presupuesto-box">0 ‚Ç¨</div>
        </div>
    </div>
    <button onclick="logout()" class="btn-logout">Cerrar Sesi√≥n</button>
</header>

<div id="bar-online" class="online-bar" onclick="verQuienEstaOnline()">
    <span class="online-dot"></span> Usuarios en l√≠nea: <span id="num-online">1</span>
</div>

<nav>
    <button onclick="cambiarPesta√±a('plantilla')" id="tab-plantilla" class="active">üë• Plantilla</button>
    <button onclick="cambiarPesta√±a('alineacion')" id="tab-alineacion">‚öΩ Mi alineaci√≥n</button>
    <button onclick="cambiarPesta√±a('mercado')" id="tab-mercado">üõí Mercado</button>
    <button onclick="cambiarPesta√±a('rivales')" id="tab-rivales">üïµÔ∏è M√°nagers</button>
    <button onclick="cambiarPesta√±a('ofertas')" id="tab-ofertas">
        ü§ù Ofertas
        <div id="notif-ofertas" class="notif-badge"></div> </button>
    <button onclick="cambiarPesta√±a('clasificacion')" id="tab-clasificacion">üèÜ Clasificaci√≥n</button>
    <button onclick="cambiarPesta√±a('ranking')" id="tab-ranking">üåü Mejores Jugadores</button>
    <button onclick="cambiarPesta√±a('historial')" id="tab-historial">üìú Mis jornadas </button>
    <button onclick="cambiarPesta√±a('noticias')" id="tab-noticias">üì∞ Noticias</button>
    <button onclick="window.location.href='resumen.html'" class="btn-partido">üèüÔ∏è Partidos</button>
    <button onclick="cambiarPesta√±a('admin')" id="tab-admin" class="admin-tab oculto">ADMIN</button>
</nav>

<div id="sec-plantilla" class="seccion">
    <h3>Tu Plantilla</h3>
    <div id="grid-mi-plantilla" class="grid-jugadores">Cargando...</div>
</div>

<div id="sec-alineacion" class="seccion oculto">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3>Alineaci√≥n <span style="font-size:0.7em; color:#1565c0;">(Jornada <span id="num-jornada-alineacion"></span>)</span></h3>
        <span style="background:#e3f2fd; padding:3px 10px; border-radius:15px; color:#0d47a1; font-weight:bold; font-size:0.9em;">
                <span id="contador-alineados">0</span>/7
            </span>
    </div>
    <p style="font-size:0.8em; color:#d32f2f;" id="aviso-saldo">‚ö†Ô∏è Si tu saldo es negativo, har√°s 0 puntos.</p>
    <div id="grid-alineacion" class="grid-jugadores">Cargando...</div>
    <button class="btn-action-big" onclick="guardarAlineacion()">üíæ GUARDAR ALINEACI√ìN</button>
</div>

<div id="sec-mercado" class="seccion oculto">
    <div class="market-header">
        <span style="font-weight:bold; font-size:1.1rem;">Mercado Libre</span>
        <div id="msg-mercado-cerrado" class="oculto" style="font-size:0.8em; color:#d32f2f;">‚õî Cerrado de 21:30 a 10:00</div>
        <span style="font-size:0.7em; color:#666;">Se renueva en: </span>
        <div id="market-countdown" class="timer-badge">--:--:--</div>
    </div>
    <div id="grid-mercado" class="grid-jugadores">Cargando...</div>
</div>

<div id="sec-rivales" class="seccion oculto">
    <h3>Managers</h3>
    <div id="lista-rivales" style="display:flex; flex-direction:column; gap:8px;">Cargando...</div>
</div>

<div id="sec-detalle-rival" class="seccion oculto">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #ddd; padding-bottom:10px;">
        <h3 id="titulo-espia" style="margin:0; color:#1a237e;">Equipo Rival</h3>
        <button class="btn-back-red" onclick="cambiarPesta√±a('rivales')"> Volver </button>
    </div>
    <div id="grid-rival" class="grid-jugadores">Cargando...</div>
</div>

<div id="sec-ofertas" class="seccion oculto">
    <h3>Ofertas</h3>

    <h4 style="color:#7b1fa2; border-bottom:1px solid #eee; padding-bottom:5px;">üì• Recibidas</h4>
    <div id="lista-ofertas-recibidas">Cargando...</div>

    <h4 style="color:#0288d1; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:20px;">üì§ Enviadas </h4>
    <div id="lista-ofertas-enviadas">Cargando...</div>
</div>

<div id="sec-clasificacion" class="seccion oculto">
    <h3>Clasificaci√≥n</h3>
    <div id="lista-clasificacion">Cargando...</div>
</div>

<div id="sec-ranking" class="seccion oculto">
    <h3>üåü Mejores Jugadores (Suma total de puntos acumulados)</h3>
    <div id="lista-ranking" style="display:flex; flex-direction:column;">Cargando...</div>
</div>

<div id="sec-historial" class="seccion oculto">
    <h3>Historial de Jornadas</h3>
    <div id="lista-historial">Cargando...</div>
</div>

<div id="sec-noticias" class="seccion oculto">
    <div id="zona-premios"></div>
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>Noticias</h3>
        <small style="color:#666">En directo üî¥</small>
    </div>
    <div id="lista-noticias">Cargando...</div>
</div>

<div id="sec-admin" class="seccion oculto">
    <h3 style="color:#c62828">Panel Admin</h3>

    <div style="background:#263238; padding:15px; border-radius:10px; border:2px solid #546e7a; margin-bottom: 20px; text-align:center;">
        <h4 style="color:#cfd8dc; margin-top:0;">BLOQUEO</h4>
        <p style="font-size:0.85em; color:#b0bec5;">Todos los d√≠as que haya partido, se debe bloquear justo cuando se sepan las alineaciones..</p>

        <button id="btn-bloqueo" onclick="toggleBloqueo()" style="width:100%; padding:15px; border:none; border-radius:8px; font-weight:900; font-size:1.1em; cursor:pointer; transition:0.3s;">
            CARGANDO ESTADO...
        </button>
    </div>

    <div style="background:white; padding:15px; border-radius:10px; border:1px solid #90caf9; margin-bottom: 20px;">
        <h4>Usuarios</h4>
        <div id="admin-lista-usuarios">Cargando...</div>
    </div>

    <div style="background:white; padding:15px; border-radius:10px; border:1px solid #ffcdd2; margin-bottom: 20px;">
        <h4>üìù Gestionar Partidos</h4>
        <select id="admin-jugador" style="width:100%; padding:10px; margin-bottom:15px; border-radius:5px;"><option>Cargando...</option></select>

        <label style="font-size:0.85em; font-weight:bold;">Camiseta:</label>
        <select id="select-equipo-color" style="width:100%; padding:10px; margin-bottom:15px; border-radius:5px; background:#f0f4c3;">
            <option value="ROJO">üî¥ Rojo</option>
            <option value="AZUL">üîµ Azul</option>
            <option value="AMARILLO">üü° Amarillo</option>
            <option value="BLANCO">‚ö™ Blanco</option>
        </select>

        <div style="display:flex; gap:15px; margin-bottom:15px; align-items:center; background:#f5f5f5; padding:10px; border-radius:6px;">
            <label style="font-weight:bold; cursor:pointer;"><input type="checkbox" id="check-jugado" checked> ¬øJug√≥?</label>
            <select id="select-resultado" style="padding:5px; border-radius:4px;">
                <option value="empate">Empate </option>
                <option value="victoria">Victoria </option>
                <option value="derrota">Derrota </option>
            </select>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div><small>Goles marcados</small><input type="number" id="input-goles" placeholder="0" class="modal-input" style="margin:0;"></div>
            <div><small>Goles encajados</small><input type="number" id="input-encajados" placeholder="0" class="modal-input" style="margin:0;"></div>
            <div><small>Goles en propia</small><input type="number" id="input-autogoles" placeholder="0" class="modal-input" style="margin:0;"></div>
        </div>

        <button onclick="registrarActa()" style="background:#c62828; color:white; width:100%; padding:12px; border:none; border-radius:5px; font-weight:bold; margin-bottom:10px;">Registrar Puntos</button>
        <button onclick="cerrarJornada()" style="background:#37474f; color:white; width:100%; padding:12px; border:none; border-radius:5px; font-weight:bold;">üîÑ CERRAR JORNADA</button>
    </div>

    <div style="background:#e1f5fe; padding:15px; border-radius:10px; border:1px solid #81d4fa; margin-bottom: 20px;">
        <h4 style="color:#0277bd; margin-top:0;">üõí Gesti√≥n de Mercado</h4>
        <p style="font-size:0.85em; color:#666; margin-bottom:10px;">Renueva el mercado.</p>
        <button onclick="resetearMercado()" style="background:#0288d1; color:white; width:100%; padding:12px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">üîÑ GENERAR NUEVO MERCADO</button>
    </div>

    <div style="background:#fff3e0; padding:15px; border-radius:10px; border:1px solid #ffb74d; margin-bottom: 20px;">
        <h4 style="color:#e65100; margin-top:0;">üöë Corregir Errores (Resetear Jugador)</h4>
        <p style="font-size:0.85em; color:#666; margin-bottom:10px;">Usa esto si le diste puntos a quien no deb√≠as. Borrar√° el acta y devolver√° los puntos y valor.</p>

        <select id="admin-jugador-reset" style="width:100%; padding:10px; margin-bottom:15px; border-radius:5px;">
            <option>Cargando lista...</option>
        </select>

        <button onclick="resetearPuntos()" style="background:#e65100; color:white; width:100%; padding:12px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">‚Ü∫ RESETEAR PUNTOS JUGADOR</button>
    </div>

    <div style="background:#fffde7; padding:15px; border-radius:10px; border:1px solid #fbc02d; margin-bottom: 20px;">
        <h4 style="color:#f57f17; margin-top:0;">üîî Solicitudes de acceso</h4>
        <div id="admin-lista-pendientes">Cargando...</div>
    </div>

    <div style="background:#f3e5f5; padding:15px; border-radius:10px; border:1px solid #ce93d8; margin-bottom: 20px;">
        <h4 style="color:#7b1fa2; margin-top:0;">üóëÔ∏è Eliminar jugadores</h4>
        <p style="font-size:0.85em; color:#666;">Selecciona al jugador para borrarlo definitivamente de la base de datos.</p>

        <select id="select-eliminar-jugador" style="width:100%; padding:10px; margin-bottom:15px; border-radius:5px;">
            <option>Cargando lista...</option>
        </select>

        <button onclick="eliminarJugadorSeleccionado()" style="background:#8e24aa; color:white; width:100%; padding:12px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">üö´ BORRAR JUGADOR</button>
    </div>

    <div style="background:#ffebee; padding:15px; border-radius:10px; border:2px dashed #c62828;">
        <h4 style="color:#b71c1c; margin-top:0;">‚ò¢Ô∏è ZONA DE PELIGRO</h4>
        <button onclick="resetearLiga()" style="background:#d32f2f; color:white; width:100%; padding:15px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">‚ö†Ô∏è RESETEAR LIGA COMPLETA</button>
    </div>
</div>

<div id="modal-overlay" class="oculto">
    <div class="modal-box">
        <div id="modal-content-wrapper">
            <h3 id="modal-titulo" class="modal-titulo">T√≠tulo</h3>
            <p id="modal-mensaje" class="modal-mensaje">Mensaje...</p>
            <div id="modal-input-container" class="oculto">
                <input type="text" id="modal-input" class="modal-input" placeholder="Escribe aqu√≠...">
                <div id="modal-info-extra" class="modal-info-extra oculto"></div>
            </div>
        </div>

        <div id="modal-jugador-detalle" class="oculto"></div>

        <div class="modal-buttons" style="margin-top:20px;">
            <button id="btn-modal-cancel" class="btn-modal btn-modal-cancel">Cancelar</button>
            <button id="btn-modal-ok" class="btn-modal btn-modal-ok">Confirmar</button>
        </div>
    </div>
</div>

<script>
    const usuarioId = localStorage.getItem('usuarioId');
    const esAdmin = (localStorage.getItem('esAdmin') === 'true');
    let presupuesto = parseInt(localStorage.getItem('presupuesto') || 0);
    const formatoDinero = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
    let listaUsuariosOnline = [];
    let modalCallback = null;

    function mostrarModal(titulo, mensaje, tipo, callback) {
        document.getElementById('modal-content-wrapper').classList.remove('oculto');
        document.getElementById('modal-jugador-detalle').classList.add('oculto');
        document.getElementById('modal-titulo').innerText = titulo;
        document.getElementById('modal-mensaje').innerText = mensaje;
        document.getElementById('modal-overlay').classList.remove('oculto');

        const btnOk = document.getElementById('btn-modal-ok');
        const inputContainer = document.getElementById('modal-input-container');
        const input = document.getElementById('modal-input');
        const infoExtra = document.getElementById('modal-info-extra');

        input.value = '';
        inputContainer.classList.add('oculto');
        infoExtra.classList.add('oculto');
        btnOk.className = 'btn-modal btn-modal-ok'; // Azul por defecto
        btnOk.classList.remove('oculto');
        btnOk.innerText = "Confirmar"; // Texto por defecto

        if (tipo === 'input' || tipo === 'blindar' || tipo === 'oferta') {
            inputContainer.classList.remove('oculto');

            if(tipo === 'oferta') {
                input.placeholder = "Cantidad a ofrecer";
                input.type = "text";
                input.onkeyup = function() {
                    let val = this.value.replace(/\./g, '').replace(/\D/g, '');
                    if(val === "") { this.value = ""; return; }
                    let num = parseInt(val);
                    this.value = num.toLocaleString('es-ES');
                };
            }
            else if(tipo === 'blindar') {
                input.placeholder = "Cantidad a invertir (sin puntos)";
                input.type = "number";
                input.onkeyup = function() {
                    let val = parseInt(this.value);
                    if(!isNaN(val) && val > 0) {
                        infoExtra.classList.remove('oculto');
                        infoExtra.innerHTML = `<strong>Coste:</strong> ${formatoDinero.format(val)}<br><strong>Subida Cl√°usula:</strong> ${formatoDinero.format(val*2)}`;
                    } else { infoExtra.classList.add('oculto'); }
                }
            } else {
                input.placeholder = "Escribe...";
                input.type = "text";
                input.onkeyup = null;
            }

        } else if (tipo === 'danger') {
            inputContainer.classList.remove('oculto');
            input.placeholder = "Escribe RESET para confirmar";
            btnOk.className = 'btn-modal btn-modal-danger';
        } else if (tipo === 'info') {
            btnOk.classList.add('oculto');

        } else if (tipo === 'vender') {
            btnOk.className = 'btn-modal btn-modal-danger'; // Lo pone ROJO
            btnOk.innerText = "Vender"; // Cambia el texto
        }

        modalCallback = () => {
            // A√±adimos 'vender' aqu√≠ para que ejecute el callback sin pedir input
            if (tipo === 'confirm' || tipo === 'vender') callback();
            else if (tipo === 'input' || tipo === 'blindar' || tipo === 'danger') callback(input.value);
            else if (tipo === 'oferta') {
                let valLimpio = input.value.replace(/\./g, '');
                callback(valLimpio);
            }
            cerrarModal();
        };
    }

    function verDetalleJugador(id, nombre, img) {
        document.getElementById('modal-overlay').classList.remove('oculto');
        document.getElementById('modal-content-wrapper').classList.add('oculto');
        const detalleDiv = document.getElementById('modal-jugador-detalle');
        detalleDiv.classList.remove('oculto');
        document.getElementById('btn-modal-ok').classList.add('oculto');
        document.getElementById('btn-modal-cancel').innerText = "Cerrar";

        detalleDiv.innerHTML = `
            <img src="${img}" class="modal-jugador-img">
            <h3 style="margin:0; color:#1a237e;">${nombre}</h3>
            <div id="stats-loading">Cargando historial...</div>
            <div id="stats-content" class="detalle-stats"></div>
        `;

        fetch(`/jugador/${id}/historial-puntos`).then(r=>r.json()).then(stats => {
            document.getElementById('stats-loading').style.display = 'none';
            const content = document.getElementById('stats-content');
            if(stats.length === 0) content.innerHTML = '<p>Sin puntos registrados.</p>';
            else {
                content.innerHTML = stats.map(s => {
                    let colorClass = s.puntos > 0 ? 'bg-green' : (s.puntos < 0 ? 'bg-red' : 'bg-orange');
                    return `
                        <div class="stat-row">
                            <span>Jornada ${s.jornada}</span>
                            <span class="badge-puntos ${colorClass}">${s.puntos}</span>
                        </div>
                    `;
                }).join('');
            }
        });
    }

    function cerrarModal() {
        document.getElementById('modal-overlay').classList.add('oculto');
        modalCallback = null;
        document.getElementById('btn-modal-cancel').innerText = "Cancelar";
        document.getElementById('btn-modal-ok').classList.remove('oculto');
    }
    document.getElementById('btn-modal-ok').onclick = () => { if(modalCallback) modalCallback(); };
    document.getElementById('btn-modal-cancel').onclick = cerrarModal;

    if (!usuarioId) window.location.href = 'login.html';

    window.onload = function() {
        document.getElementById('titulo-web').innerText = localStorage.getItem('usuarioNombre');
        actualizarPresupuestoUI();
        if (esAdmin) {
            document.getElementById('tab-admin').classList.remove('oculto');
            cargarUsuariosAdmin();
            pintarSelectAdmin();
            actualizarBotonBloqueo();
        }
        cargarTodo();
        cargarOfertas();
        setInterval(cargarNoticias, 5000);
        iniciarContadorMercado();
        iniciarRelojesBlindaje();
        setInterval(pingOnline, 5000); //Cada 5 segundos
        pingOnline();
    };

   function iniciarContadorMercado() {
        function actualizar() {
            const now = new Date();
            const minutosDia = now.getHours() * 60 + now.getMinutes();

            //21:30 = 1290 minutos
            const cerradoNoche = 1290;

            //10:00 = 600 minutos
            const cerradoMadrugada = 600;
            const msgCerrado = document.getElementById('msg-mercado-cerrado');

            //Si es m√°s tarde de las 21:30 O m√°s temprano de las 10:00 -> Muestra mensaje
            if (minutosDia >= cerradoNoche || minutosDia < cerradoMadrugada) {
                msgCerrado.classList.remove('oculto');
            } else {
                msgCerrado.classList.add('oculto');
            }

            // 2. L√≥gica del contador (existente)
            const fechaMadridStr = now.toLocaleString("en-US", {timeZone: "Europe/Madrid"});
            const nowMadrid = new Date(fechaMadridStr);
            const midnightMadrid = new Date(nowMadrid);
            midnightMadrid.setHours(24, 0, 0, 0);
            const diferencia = midnightMadrid - nowMadrid;

            if (diferencia > 0) {
                const h = Math.floor((diferencia % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diferencia % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diferencia % (1000 * 60)) / 1000);
                document.getElementById('market-countdown').innerText =
                    `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }
        }
        actualizar(); setInterval(actualizar, 1000);
    }

    function iniciarRelojesBlindaje() {
        setInterval(() => {
            document.querySelectorAll('.timer-blindaje').forEach(el => {
                let segs = parseInt(el.getAttribute('data-segundos'));
                if (!isNaN(segs) && segs > 0) {
                    segs--;
                    el.setAttribute('data-segundos', segs);
                    // Formato Dias, Horas, Minutos, Segundos
                    let d = Math.floor(segs / (3600 * 24));
                    let h = Math.floor((segs % (3600 * 24)) / 3600);
                    let m = Math.floor((segs % 3600) / 60);
                    let s = segs % 60;
                    el.innerText = `${d}d ${h}h ${m}m ${s}s`;
                } else {
                    el.innerText = "Expirado";
                    el.style.color = "#d32f2f";
                }
            });
        }, 1000);
    }

    function cargarTodo() {
        fetch('/jornada/actual').then(r=>r.json()).then(n => {
            document.getElementById('badge-jornada').innerText = "J-" + n;
            document.getElementById('num-jornada-alineacion').innerText = n;
        });

        fetch('/jugadores').then(r=>r.json()).then(jugadores => {
            window.todosLosJugadores = jugadores;
            pintarPlantilla(jugadores);
            pintarRanking(jugadores);

            fetch(`/alineacion/${usuarioId}`).then(r => r.json()).then(alineados => {
                const idsAlineados = new Set(alineados.map(a => a.id));
                pintarAlineacion(jugadores, idsAlineados);
            });
        });

        fetch('/mercado-diario?t=' + new Date().getTime())
            .then(r=>r.json())
            .then(mercado => {
                pintarMercado(mercado);
            });

        fetch('/usuarios').then(r=>r.json()).then(usuarios => {
            pintarRivales(usuarios);
            const yo = usuarios.find(u => u.id == usuarioId);

            if (!yo) {
                alert("‚õî Tu usuario ha sido eliminado o no existe.");
                logout(); // Borra credenciales y te manda al login
                return;
            }

            if (yo) {
                presupuesto = yo.presupuesto;
                localStorage.setItem('presupuesto', presupuesto);
                actualizarPresupuestoUI();
            }
        });

        fetch('/clasificacion').then(r=>r.json()).then(data => {
            let html = data.map((fila, i) => `
                <div class="fila-clasif">
                    <div class="clasif-user">
                        <span class="pos-num">${i+1}¬∫</span>
                        <div class="avatar-small">üë§</div>
                        <strong>${fila.nombre}</strong>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:#1a237e;">${fila.puntos} pts</div>
                        <div style="font-size:0.85em; color:#666;">üí∞ ${formatoDinero.format(fila.valorPlantilla)}</div>
                    </div>
                </div>`).join('');
            document.getElementById('lista-clasificacion').innerHTML = html;
        });

        cargarHistorial();
        cargarNoticias();
    }

    function pintarRanking(jugadores) {
        let lista = [...jugadores];
        // Ordenar: Puntos DESC, luego Nombre ASC
        lista.sort((a, b) => {
            if (b.puntosAcumulados !== a.puntosAcumulados) {
                return b.puntosAcumulados - a.puntosAcumulados;
            }
            return a.nombre.localeCompare(b.nombre);
        });

        let html = lista.map((j, i) => {
            let extraClass = '';
            let icon = `#${i+1}`;
            if (i === 0) { extraClass = 'top-1'; icon = 'ü•á'; }
            else if (i === 1) { extraClass = 'top-2'; icon = 'ü•à'; }
            else if (i === 2) { extraClass = 'top-3'; icon = 'ü•â'; }

            // Imagen circular peque√±a
            let img = j.urlImagen && j.urlImagen.startsWith('/') ? j.urlImagen : (j.urlImagen || 'https://via.placeholder.com/150');

            return `
            <div class="fila-ranking ${extraClass}">
                <div class="ranking-details">
                    <span class="ranking-medal">${icon}</span>
                    <div class="avatar-small">
                        <img src="${img}" style="width:100%; height:100%; object-fit:cover;">
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <strong style="color:#1a237e;">${j.nombre}</strong>
                        <small style="opacity:0.7">${j.posicion}</small>
                    </div>
                </div>
                <div class="ranking-points">${j.puntosAcumulados} pts</div>
            </div>`;
        }).join('');

        document.getElementById('lista-ranking').innerHTML = html;
    }

    function cargarHistorial() {
        fetch('/historial/' + usuarioId).then(r=>r.json()).then(historial => {
            const div = document.getElementById('lista-historial');
            if (historial.length === 0) {
                div.innerHTML = '<p>No hay jornadas registradas.</p>';
                return;
            }
            div.innerHTML = historial.map(h => {
                let jugadoresHtml = h.jugadores.map(j => {
                    let colorClass = j.puntos > 0 ? 'text-green' : (j.puntos < 0 ? 'text-red' : 'text-orange');
                    return `
                    <div class="player-mini">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>${j.nombre}</strong>
                            <span class="mini-puntos ${colorClass}">${j.puntos}</span>
                        </div>
                        <span class="mini-pos">${j.posicion}</span>
                    </div>`;
                }).join('');

                return `
                <div class="historial-card">
                    <div class="historial-header">
                        <span>Jornada ${h.jornadaNumero}</span>
                        <span class="historial-badge">${h.puntosTotal} pts</span>
                    </div>
                    <div class="historial-body">
                        ${jugadoresHtml || '<small>Sin jugadores alineados</small>'}
                    </div>
                </div>`;
            }).join('');
        });
    }

    function cargarNoticias() {
        fetch('/noticias').then(r=>r.json()).then(noticias => {
            let html = noticias.map(n => `<div class="noticia-item ${n.mensaje.includes("CL√ÅUSULAZO") || n.mensaje.includes("ADMIN") ? 'noticia-robo':''}"><span class="noticia-fecha">${n.fechaBonita}</span><span class="noticia-texto">${n.mensaje}</span></div>`).join('');
            const container = document.getElementById('lista-noticias');
            if (container.innerHTML !== html) container.innerHTML = html || '<p>No hay noticias.</p>';
        });

        fetch('/premios-pendientes/' + usuarioId).then(r=>r.json()).then(premios => {
            const zonaPremios = document.getElementById('zona-premios');
            if (premios.length > 0) {
                let htmlPremios = premios.map(p => {
                    // L√≥gica visual para el MVP
                    let htmlMvp = '';
                    let claseExtra = '';

                    if (p.tieneMvp) {
                        claseExtra = 'border: 2px solid #ffd700; background: #fffde7;'; // Borde dorado y fondo amarillo claro
                        htmlMvp = `<div style="background:#ffd700; color:#333; padding:5px; border-radius:4px; margin-top:5px; font-size:0.9em; text-align:center;">
                                      <strong>üèÜ ¬°BONUS MVP!</strong><br>
                                      Ten√≠as a ${p.nombreMvp}<br>
                                      <span style="font-weight:900;">+${p.bonusFmt}</span>
                                   </div>`;
                    }

                    return `
                    <div class="bloque-premios" style="${claseExtra}">
                        <div>
                            <strong>üèÅ JORNADA ${p.jornada}</strong><br>
                            Has ganado: ${p.puntos} pts
                            ${htmlMvp}
                        </div>
                        <button class="btn-reclamar" onclick="reclamar(${p.idEquipo})">Reclamar ${p.dineroFmt}</button>
                    </div>
                `;
                }).join('');
                zonaPremios.innerHTML = htmlPremios;
            } else { zonaPremios.innerHTML = ''; }
        });
    }

    function reclamar(idEquipo) { post(`/reclamar-premio/${idEquipo}`, {}); }

    function cargarUsuariosAdmin() {
        fetch('/admin/usuarios-gestion').then(r => r.json()).then(usuarios => {
            document.getElementById('admin-lista-usuarios').innerHTML = usuarios.map(u => `
                <div class="user-row">
                    <div style="overflow:hidden; text-overflow:ellipsis;">
                        <strong>${u.nombre}</strong> ${u.esAdmin ? '(ADMIN)' : ''}<br>
                        <small style="color:#666;">Pass: ${u.password}</small>
                    </div>
                    <div style="flex-shrink:0;">
                        <button class="btn-edit-user" onclick="editarUsuario(${u.id}, '${u.nombre}')">‚úèÔ∏è</button>

                        ${(!u.esAdmin || u.nombre === 'Cristian') ? `<button class="btn-delete-user" onclick="expulsarUsuario(${u.id}, '${u.nombre}')">Expulsar</button>` : ''}                    </div>
                </div>
            `).join('');
        });

        fetch('/admin/pendientes').then(r => r.json()).then(pendientes => {
            const div = document.getElementById('admin-lista-pendientes');
            if(pendientes.length === 0) {
                div.innerHTML = '<small>No hay solicitudes.</small>';
            } else {
                div.innerHTML = pendientes.map(u => `
                    <div class="solicitud-row">
                        <strong>${u.nombre}</strong>
                        <div>
                            <button class="btn-aprobar" onclick="gestionarUsuario(${u.id}, 'aprobar')">‚úÖ</button>
                            <button class="btn-rechazar" onclick="gestionarUsuario(${u.id}, 'rechazar')">‚ùå</button>
                        </div>
                    </div>
                `).join('');
            }
        });
    }

    function gestionarUsuario(id, accion) {
        let method = accion === 'aprobar' ? 'POST' : 'DELETE';
        fetch(`/admin/${accion}/${id}`, { method: method })
        .then(r => r.text())
        .then(msg => {
            mostrarModal("Gesti√≥n", msg, 'confirm', () => cargarUsuariosAdmin());
        });
    }

    function crearCarta(j, tipo, alineado = false) {
        let img = j.urlImagen && j.urlImagen.startsWith('/') ? j.urlImagen : (j.urlImagen || 'https://via.placeholder.com/150');
        let precio = formatoDinero.format(j.valor);
        let clausula = formatoDinero.format(j.clausula);
        let contenido = '';
        let extraClass = alineado ? 'alineado' : '';
        let checked = alineado ? 'checked' : '';

        let overlay = '';

        if (j.blindado) {
            if(tipo === 'robar') {
                overlay = `<div class="blindado-overlay">
                                <div class="candado-icon">üîí</div>
                                <div class="timer-blindaje" data-segundos="${j.segundosBlindaje}">Calculando...</div>
                           </div>`;
            }
        }

        let colorTriangulo = 'triangle-pos';
        if (j.puntosAcumulados < 0) colorTriangulo = 'triangle-neg';
        else if (j.puntosAcumulados === 0) colorTriangulo = 'triangle-neu';

        if (tipo === 'alinear') {
            contenido = `<div class="alineacion-overlay"><input type="checkbox" class="check-alinear" value="${j.id}" ${checked} onclick="actualizarContador(this)"></div>`;
        }
        else if (tipo === 'fichar') {
            contenido = `<button class="btn-card btn-fichar" onclick="fichar(${j.id}, ${j.valor})">Fichar (${precio})</button>`;
        }
        else if (tipo === 'robar') {
            let btnRobar = `<button class="btn-card btn-robar" onclick="robar(${j.id}, ${j.clausula})">Fichar: ${clausula}</button>`;
            let btnOferta = `<button class="btn-card btn-ofertar" onclick="hacerOferta(${j.id}, '${j.nombre}')">ü§ù Negociar</button>`;

            if (j.blindado) btnRobar = '';

            contenido = `
                <div class="card-coste" style="margin-bottom:5px;">Valor: ${precio}</div>
                ${btnRobar}
                ${btnOferta}
            `;
        }
        else if (tipo === 'gestion') {
            let htmlBlindaje = '';
            if (j.blindado) {
                // Usamos la clase 'timer-blindaje' para que el script del reloj lo detecte autom√°ticamente
                // Y 'timer-mini' para que se vea peque√±o
                htmlBlindaje = `<div class="timer-blindaje timer-mini" data-segundos="${j.segundosBlindaje}">‚è≥ Calculando...</div>`;
            }

            contenido = `
                <div class="card-coste">Coste: ${precio}</div>
                <div class="card-clausula">üîí ${clausula}</div>
                ${htmlBlindaje}
                <div style="display:flex; gap:5px; margin-top:auto; width:100%;">
                    <button class="btn-card btn-vender" style="flex:1;" onclick="vender(${j.id}, ${j.valor}, ${j.clausula})">Vender</button>
                    <button class="btn-card btn-blindar" style="flex:1;" onclick="blindar(${j.id})">Subir üîí</button>
                </div>`;
        }

        let accionDetalle = `onclick="verDetalleJugador(${j.id}, '${j.nombre}', '${img}')"`;
        let posClass = 'pos-' + j.posicion.toLowerCase();

        return `<div class="card ${extraClass}" id="card-${j.id}">
            <div class="puntos-triangle ${colorTriangulo}"></div>
            <div class="puntos-val">${j.puntosAcumulados}</div>
            ${tipo === 'alinear' ? contenido : ''}
            <div class="card-img-container" ${accionDetalle}><img src="${img}" class="card-img">${overlay}</div>
            <div class="card-body">
                <div ${accionDetalle}>
                    <div class="card-name">${j.nombre}</div>
                    <div class="card-pos-badge ${posClass}">${j.posicion}</div>
                </div>
                ${tipo !== 'alinear' ? contenido : ''}
            </div>
        </div>`;
    }

    function pintarPlantilla(jugadores) { document.getElementById('grid-mi-plantilla').innerHTML = jugadores.filter(j => j.propietario && j.propietario.id == usuarioId).map(j => crearCarta(j, 'gestion')).join('') || '<p>Sin jugadores.</p>'; }
    function pintarAlineacion(jugadores, idsAlineados) {
        const misJugadores = jugadores.filter(j => j.propietario && j.propietario.id == usuarioId);
        misJugadores.sort((a, b) => {
            const aAlineado = idsAlineados.has(a.id) ? 1 : 0;
            const bAlineado = idsAlineados.has(b.id) ? 1 : 0;
            return bAlineado - aAlineado;
        });
        document.getElementById('grid-alineacion').innerHTML = misJugadores.map(j => crearCarta(j, 'alinear', idsAlineados.has(j.id))).join('') || '<p>Sin jugadores.</p>';
        actualizarContador();
    }
    function pintarMercado(jugadores) { document.getElementById('grid-mercado').innerHTML = jugadores.map(j => crearCarta(j, 'fichar')).join('') || '<p>Mercado cerrado o vac√≠o.</p>'; }
    function pintarRivales(usuarios) { document.getElementById('lista-rivales').innerHTML = usuarios.filter(u => u.id != usuarioId).map(u => `<div style="background:white; padding:15px; border-radius:8px; cursor:pointer; font-weight:bold; display:flex; justify-content:space-between;" onclick="espiar(${u.id}, '${u.nombre}')"><span>‚öΩ ${u.nombre}</span> <span>üîç</span></div>`).join(''); }

    function espiar(id, nombre) {
        document.querySelectorAll('.seccion').forEach(s => s.classList.add('oculto'));
        const seccionEspia = document.getElementById('sec-detalle-rival');
        seccionEspia.classList.remove('oculto');

        document.getElementById('titulo-espia').innerText = "Equipo de " + nombre;
        document.getElementById('grid-rival').innerHTML = window.todosLosJugadores.filter(j => j.propietario && j.propietario.id == id).map(j => crearCarta(j, 'robar')).join('') || '<p>Sin jugadores.</p>';
    }

    function actualizarContador(checkbox) {
        if(checkbox) {
            const card = document.getElementById('card-' + checkbox.value);
            if(checkbox.checked) card.classList.add('alineado'); else card.classList.remove('alineado');
        }
        document.getElementById('contador-alineados').innerText = document.querySelectorAll('.check-alinear:checked').length;
    }

    function fichar(id, p) { mostrarModal("Fichar Jugador", `¬øFichar por ${formatoDinero.format(p)}?`, 'confirm', () => post(`/mercado/comprar/${id}/${usuarioId}`, {}, p)); }
    function robar(id, p) { mostrarModal("Fichar por Cl√°usula", `¬øPagar cl√°usula de ${formatoDinero.format(p)}?`, 'confirm', () => post(`/mercado/robar/${id}/${usuarioId}`, {}, p)); }
    function vender(id, valor, clausula) {
        let ingreso = valor + (clausula - valor) / 2;
        mostrarModal(
            "Vender al Mercado",
            `Recuperar√°s Coste + Inversi√≥n.\n\nüí∞ Recibir√°s: ${formatoDinero.format(ingreso)}\n\n¬øConfirmar venta?`,
            'vender',
            () => post(`/mercado/vender/${id}/${usuarioId}`, {}, -ingreso)
        );
    }
    function blindar(id) {
        mostrarModal("Subir Cl√°usula üîí", "Introduce cantidad a invertir.", 'blindar', (cant) => {
            let valor = parseInt(cant);
            if (!isNaN(valor) && valor > 0) {
                post(`/jugador/subir-clausula/${id}/${valor}`, {}, valor);
            } else {
                mostrarModal("‚õî Error", "Debes introducir un n√∫mero v√°lido.", 'confirm', ()=>{});
            }
        });
    }

    // üÜï FUNCIONES OFERTAS
    function hacerOferta(idJugador, nombreJugador) {
        mostrarModal("Oferta por " + nombreJugador, "Introduce cantidad:", 'oferta', (cant) => {
            if(cant > 0) {
                const data = { idJugador: idJugador, idComprador: usuarioId, cantidad: cant };
                post('/ofertas/crear', data);
            }
        });
    }

    function cargarOfertas() {
        // üî¥ CAMBIO: Ahora llama a 'mis-ofertas' que devuelve {recibidas:[], enviadas:[]}
        fetch(`/ofertas/mis-ofertas/${usuarioId}`).then(r=>r.json()).then(data => {

            const divRecibidas = document.getElementById('lista-ofertas-recibidas');
            const divEnviadas = document.getElementById('lista-ofertas-enviadas');
            const tabButton = document.getElementById('tab-ofertas');
            const notifBadge = document.getElementById('notif-ofertas');

            // 1. GESTIONAR NOTIFICACI√ìN (ROJA)
            if(data.recibidas.length > 0) {
                tabButton.classList.add('notif-active');
            } else {
                tabButton.classList.remove('notif-active');
            }

            // 2. PINTAR RECIBIDAS
            if(data.recibidas.length === 0) {
                divRecibidas.innerHTML = '<p style="font-size:0.9em; color:#888;">No tienes ofertas pendientes.</p>';
            } else {
                divRecibidas.innerHTML = data.recibidas.map(o => `
                    <div class="oferta-item">
                        <div class="oferta-info">
                            <strong>${o.comprador}</strong> quiere a <strong>${o.jugador}</strong><br>
                            Oferta: <span style="color:#2e7d32; font-weight:bold;">${o.cantidadFmt}</span>
                        </div>
                        <div>
                            <button class="btn-oferta-ok" onclick="responderOferta(${o.id}, 'aceptar')">‚úî</button>
                            <button class="btn-oferta-ko" onclick="responderOferta(${o.id}, 'rechazar')">‚úñ</button>
                        </div>
                    </div>
                `).join('');
            }

            // 3. PINTAR ENVIADAS
            if(data.enviadas.length === 0) {
                divEnviadas.innerHTML = '<p style="font-size:0.9em; color:#888;">No has hecho ofertas.</p>';
            } else {
                divEnviadas.innerHTML = data.enviadas.map(o => `
                    <div class="oferta-item enviada">
                        <div class="oferta-info">
                            Quieres a <strong>${o.jugador}</strong> (de ${o.vendedor})<br>
                            Tu oferta: <span style="color:#0277bd; font-weight:bold;">${o.cantidadFmt}</span>
                        </div>
                        <div style="font-size:0.8em; color:#666; font-style:italic;">Pendiente...</div>
                    </div>
                `).join('');
            }
        });
    }

    function responderOferta(idOferta, accion) {
        post(`/ofertas/responder/${idOferta}/${accion}`, {});
    }

    function expulsarUsuario(id, nombre) { mostrarModal("Expulsar", `¬øEchar a ${nombre}?`, 'confirm', () => { fetch(`/admin/eliminar-usuario/${id}`, { method: 'DELETE' }).then(r=>r.text()).then(msg => { mostrarModal("Info", msg, 'confirm', ()=>{ cargarUsuariosAdmin(); cargarTodo(); }); }); }); }

    function resetearLiga() {
        mostrarModal("‚ö†Ô∏è PELIGRO: RESET", "Escribe RESET para borrar todo:", 'danger', (t) => {
            if(t==="RESET") {
                fetch('/admin/reset-liga', { method: 'POST' })
                .then(r => r.text())
                .then(msg => {
                    mostrarModal("Info", msg, 'confirm', () => {
                        location.reload();
                    });
                });
            } else {
                mostrarModal("Error","C√≥digo mal.",'confirm',()=>{});
            }
        });
    }

    function editarUsuario(id, nombreActual) {
        mostrarModal("Cambiar Nombre", "Introduce el nuevo nombre para " + nombreActual + ":", 'input', (nuevoNombre) => {
            if (nuevoNombre && nuevoNombre.trim() !== "") {
                post(`/admin/editar-usuario/${id}`, { nombre: nuevoNombre.trim() });
                setTimeout(cargarUsuariosAdmin, 1000);
            }
        });
    }

    function guardarAlineacion() {
    const ids = Array.from(document.querySelectorAll('.check-alinear:checked')).map(cb => parseInt(cb.value));

    if(ids.length > 7) {
        mostrarModal("Alineaci√≥n", "M√°ximo 7 jugadores.", 'confirm', ()=>{});
        return;
    }

    post(`/alinear/${usuarioId}`, ids);
}

    function post(url, data, coste = 0) {
        fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) })
        .then(r => r.text()).then(msg => {
            let titulo = msg.includes("‚ùå") || msg.includes("‚õî") ? "Info" : "‚úÖ √âxito"; // Cambio para que "Mercado Cerrado" no salga rojo error cr√≠tico
            mostrarModal(titulo, msg, 'confirm', () => {
                if(!msg.includes("‚ùå") && !msg.includes("‚õî")) {
                    if(coste !== 0) {
                        presupuesto -= coste;
                        localStorage.setItem('presupuesto', presupuesto);
                        actualizarPresupuestoUI();
                    }
                    if (presupuesto < 0) {
                        mostrarModal("‚ö†Ô∏è AVISO DE SALDO", "¬°Est√°s en n√∫meros rojos!\n\nAseg√∫rate de tener saldo positivo antes de que empiece la siguiente jornada para poder puntuar.", "confirm", ()=>{});
                    }
                    cargarTodo();
                    cargarOfertas();
                    if(esAdmin) cargarUsuariosAdmin();
                }
            });
        });
    }

    function pintarSelectAdmin() {
        // Carga lista para registrar
        fetch('/admin/jugadores-pendientes').then(r=>r.json()).then(jugadores => {
            const select = document.getElementById('admin-jugador');
            if (jugadores.length === 0) {
                select.innerHTML = '<option>Todos puntuados</option>';
            } else {
                select.innerHTML = jugadores.map(j => `<option value="${j.id}">${j.nombre} (${j.posicion})</option>`).join('');
            }
        });
        cargarJugadoresPuntuados();
    }

    function cargarJugadoresPuntuados() {
        fetch('/admin/jugadores-puntuados').then(r=>r.json()).then(jugadores => {
            const select = document.getElementById('admin-jugador-reset');
            if (jugadores.length === 0) {
                select.innerHTML = '<option>Nadie ha puntuado a√∫n</option>';
            } else {
                select.innerHTML = jugadores.map(j => `<option value="${j.id}">${j.nombre} (${j.posicion})</option>`).join('');
            }
        });
    }

    function resetearPuntos() {
        const idJugador = document.getElementById('admin-jugador-reset').value;
        if (!idJugador || isNaN(idJugador)) {
            mostrarModal("Error", "Selecciona un jugador v√°lido.", 'confirm', ()=>{});
            return;
        }

        mostrarModal("‚ö†Ô∏è Confirmar Reset", "¬øSeguro que quieres borrar los puntos de este jugador? Se revertir√° su valor y cl√°usula.", 'confirm', () => {
            post(`/admin/reset-puntos/${idJugador}`, {});
            setTimeout(pintarSelectAdmin, 500);
        });
    }

    function registrarActa() {
        const resultado = document.getElementById('select-resultado').value;
        const datos = {
            idJugador: parseInt(document.getElementById('admin-jugador').value),
            idJornada: 1,
            jugado: document.getElementById('check-jugado').checked,
            victoria: resultado === 'victoria',
            derrota: resultado === 'derrota',
            goles: parseInt(document.getElementById('input-goles').value)||0,
            golesEncajados: parseInt(document.getElementById('input-encajados').value)||0,
            autogoles: parseInt(document.getElementById('input-autogoles').value)||0,
            equipoColor: document.getElementById('select-equipo-color').value
        };
        post('/admin/registrar', datos);
        setTimeout(pintarSelectAdmin, 500); // Recargar lista
    }

    function cerrarJornada() { mostrarModal("Cerrar Jornada", "¬øRepartir puntos y dinero?", 'confirm', () => post('/admin/cerrar-jornada', {})); }

    function cambiarPesta√±a(tab) {
        document.querySelectorAll('.seccion').forEach(s => s.classList.add('oculto'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('sec-' + tab).classList.remove('oculto');
        document.getElementById('tab-' + tab).classList.add('active');
        if(tab === 'ofertas') cargarOfertas(); // Cargar ofertas al entrar
        if(tab === 'admin') {
            cargarUsuariosAdmin();
            actualizarBotonBloqueo();
            pintarSelectAdmin();
            pintarSelectEliminar();
        }
    }
    function actualizarPresupuestoUI() { const el = document.getElementById('presupuesto-display'); el.innerText = formatoDinero.format(presupuesto); if(presupuesto < 0) { el.classList.add('presupuesto-negativo'); document.getElementById('aviso-saldo').classList.remove('oculto'); } else { el.classList.remove('presupuesto-negativo'); document.getElementById('aviso-saldo').classList.add('oculto'); } }
    function logout() { localStorage.clear(); window.location.href = 'login.html'; }

    function pingOnline() {
        if(!usuarioId) return;
        fetch(`/usuarios/ping/${usuarioId}`, { method: 'POST' })
            .then(r => r.json())
            .then(nombres => {
                listaUsuariosOnline = nombres;
                document.getElementById('num-online').innerText = nombres.length;
            });
    }

    function verQuienEstaOnline() {
        if(listaUsuariosOnline.length === 0) return;

        // 1. Mostrar el modal primero (esto borra el contenido anterior y pone el t√≠tulo)
        mostrarModal("Usuarios en l√≠nea üü¢", "", 'info', ()=>{});

        // 2. Y LUEGO inyectamos la lista HTML (para que no se borre)
        let listaHTML = listaUsuariosOnline.map(n => `<li style="margin-bottom:5px;">üë§ ${n}</li>`).join('');
        document.getElementById('modal-mensaje').innerHTML = `<ul style="list-style:none; padding:0; font-size:1.1em; text-align:left;">${listaHTML}</ul>`;
    }

    function resetearMercado() {
        mostrarModal("Resetear Mercado", "¬øSeguro que quieres cambiar los jugadores del mercado actual?", 'confirm', () => {
            post('/admin/reset-mercado', {});
        });
    }

    function eliminarJugador() {
        mostrarModal("Eliminar jugador", "¬øSeguro que quieres borrar al jugador?", 'confirm', () => {
            post('/admin/eliminar-jugador', {});
        });
    }

    function toggleBloqueo() {
        post('/admin/toggle-bloqueo', {}, 0);
        setTimeout(actualizarBotonBloqueo, 500);
    }

    function actualizarBotonBloqueo() {
        if (!esAdmin) return;
        const btn = document.getElementById('btn-bloqueo');
        if (!btn) return;

        fetch('/admin/estado-bloqueo')
            .then(r => r.json())
            .then(bloqueado => {
                if (bloqueado) {
                    btn.innerText = "üîí BLOQUEO ACTIVO";
                    btn.style.background = "#d32f2f";
                    btn.style.color = "white";
                    btn.style.boxShadow = "0 0 15px rgba(211, 47, 47, 0.6)";
                } else {
                    btn.innerText = "üîì BLOQUEO DESACTIVADO";
                    btn.style.background = "#2e7d32";
                    btn.style.color = "white";
                    btn.style.boxShadow = "none";
                }
            });
    }

    function pintarSelectEliminar() {
        fetch('/jugadores').then(r => r.json()).then(jugadores => {
            // Ordenamos alfab√©ticamente
            jugadores.sort((a, b) => a.nombre.localeCompare(b.nombre));

            const select = document.getElementById('select-eliminar-jugador');
            if (jugadores.length === 0) {
                select.innerHTML = '<option>No hay jugadores</option>';
            } else {
                select.innerHTML = jugadores.map(j =>
                    `<option value="${j.id}">${j.nombre} (${j.posicion}) - ${j.propietario && j.propietario.nombre ? j.propietario.nombre : 'Libre'}</option>`
                ).join('');
            }
        });
    }

    function eliminarJugadorSeleccionado() {
        const select = document.getElementById('select-eliminar-jugador');
        const idJugador = select.value;
        const nombreJugador = select.options[select.selectedIndex].text;

        if (!idJugador) return;

        mostrarModal("Eliminar Jugador", `¬øEst√°s seguro de que quieres eliminar a:\n\nüëâ ${nombreJugador}?\n\nEsta acci√≥n es irreversible.`, 'confirm', () => {
            post(`/admin/eliminar-jugador/${idJugador}`, {});
            // Recargamos los selects para que desaparezca
            setTimeout(() => {
                pintarSelectEliminar();
                pintarSelectAdmin(); // Para actualizar el de registrar partido tambi√©n
            }, 1000);
        });
    }
</script>
</body>
</html>