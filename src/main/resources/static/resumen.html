<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumen Jornada</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1a1a1a; color: white; margin: 0; padding: 10px; text-align: center; }

        .controls {
            background: #333; padding: 15px; border-radius: 12px; margin-bottom: 20px;
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        input { padding: 10px; border-radius: 5px; border: none; text-align: center; width: 60px; font-weight: bold; font-size: 1rem; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-buscar { background: #ffd700; color: #333; }
        .btn-toggle { background: #2196f3; color: white; }
        .btn-volver { background-color: #d32f2f; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block; }

        .campo {
            background: linear-gradient(to bottom, #4caf50, #388e3c);
            width: 100%; max-width: 600px; height: 850px;
            margin: 0 auto; border: 4px solid white; border-radius: 10px;
            position: relative; display: flex; flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .linea-medio { position: absolute; top: 50%; width: 100%; height: 4px; background: rgba(255,255,255,0.6); }
        .circulo-central { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80px; height: 80px; border: 4px solid rgba(255,255,255,0.6); border-radius: 50%; }
        .equipo-area { flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; padding: 10px 0; z-index: 2; }
        .equipo-top { flex-direction: column; }
        .equipo-bottom { flex-direction: column-reverse; }
        .linea-jugadores { display: flex; justify-content: center; gap: 8px; }
        .jugador-card { width: 65px; text-align: center; position: relative; }

        .jugador-img {
            width: 45px; height: 45px; border-radius: 50%;
            border: 3px solid #333; background: #fff; object-fit: cover;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        }

        .camiseta-ROJO .jugador-img { border-color: #d32f2f; }
        .camiseta-AZUL .jugador-img { border-color: #1976d2; }
        .camiseta-AMARILLO .jugador-img { border-color: #fbc02d; }
        .camiseta-BLANCO .jugador-img { border-color: #ffffff; }

        /* CORRECCI√ìN: Z-Index 20 para estar encima del MVP */
        .puntos-badge {
            position: absolute; top: -5px; right: 0;
            color: white; font-weight: bold; font-size: 11px; width: 20px; height: 20px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 20;
        }

        .badge-green { background-color: #2e7d32; }
        .badge-red { background-color: #d32f2f; }
        .badge-orange { background-color: #f57c00; color: white; }

        .jugador-nombre { font-size: 9px; background: rgba(0,0,0,0.7); padding: 2px; border-radius: 4px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: white; }

        /* El MVP tiene z-index 10, as√≠ que el badge (20) gana */
        .mvp .jugador-img {
            box-shadow: 0 0 15px 5px #ffd700;
            transform: scale(1.2);
            border-color: #ffd700 !important;
            z-index: 10;
        }

        .mvp-crown {
            position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
            font-size: 16px; text-shadow: 0 2px 2px rgba(0,0,0,0.5); z-index: 11;
        }

        .marcador { font-size: 1.5rem; font-weight: bold; margin: 10px 0; background: #333; padding: 10px 20px; border-radius: 10px; display: inline-block; border: 1px solid #555; }
        .vista-lista { max-width: 600px; margin: 0 auto; text-align: left; }
        .manager-card { background: white; color: #333; border-radius: 8px; margin-bottom: 15px; overflow: hidden; }
        .manager-header { background: #eceff1; padding: 10px; display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #ddd; }
        .pts-badge { background: #1a237e; color: white; padding: 2px 8px; border-radius: 10px; }
        .player-row { display: flex; justify-content: space-between; padding: 5px 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .text-green { color: #2e7d32; font-weight: bold; }
        .text-red { color: #d32f2f; font-weight: bold; }
        .text-orange { color: #f57c00; font-weight: bold; }
        .oculto { display: none !important; }
    </style>
</head>
<body>

<div class="controls">
    <div style="display:flex; align-items:center; gap:5px;">
        <span>Jornada:</span>
        <input type="number" id="numJornada" value="1" min="1">
        <button class="btn-buscar" onclick="cargarTodo()">üîç</button>
    </div>
    <button class="btn-toggle" onclick="alternarVista()">üîÑ Cambiar Vista</button>
    <a href="fantasy.html" class="btn-volver">Volver</a>
</div>

<div id="vista-campo">
    <div id="marcador" class="marcador">Cargando...</div>
    <div class="campo">
        <div class="linea-medio"></div>
        <div class="circulo-central"></div>
        <div class="equipo-area equipo-top" id="area-equipo-a"></div>
        <div class="equipo-area equipo-bottom" id="area-equipo-b"></div>
    </div>
</div>

<div id="vista-lista" class="vista-lista oculto">
    <div id="lista-contenido">Cargando...</div>
</div>

<script>
    let vistaActual = 'campo';

    function alternarVista() {
        if (vistaActual === 'campo') {
            vistaActual = 'lista';
            document.getElementById('vista-campo').classList.add('oculto');
            document.getElementById('vista-lista').classList.remove('oculto');
        } else {
            vistaActual = 'campo';
            document.getElementById('vista-lista').classList.add('oculto');
            document.getElementById('vista-campo').classList.remove('oculto');
        }
    }

    async function cargarTodo() {
        const num = document.getElementById("numJornada").value;
        cargarCampo(num);
        cargarLista(num);
    }

    async function cargarCampo(num) {
        try {
            const response = await fetch(`/jornada/${num}/resumen-partido`);
            const data = await response.json();

            if(data.error) {
                document.getElementById("marcador").innerText = "‚ö†Ô∏è " + data.error;
                document.getElementById("area-equipo-a").innerHTML = "";
                document.getElementById("area-equipo-b").innerHTML = "";
                return;
            }

            const puntosA = data.equipoA.reduce((acc, j) => acc + j.puntos, 0);
            const puntosB = data.equipoB.reduce((acc, j) => acc + j.puntos, 0);

            document.getElementById("marcador").innerHTML = `
                <span style="color:${getColorCode(data.colorA)}">${data.colorA} ${puntosA}</span>
                -
                <span style="color:${getColorCode(data.colorB)}">${puntosB} ${data.colorB}</span>
            `;

            renderEquipo("area-equipo-a", data.equipoA, data.colorA);
            renderEquipo("area-equipo-b", data.equipoB, data.colorB);

        } catch (e) { console.error(e); }
    }

    async function cargarLista(num) {
        try {
            const response = await fetch(`/jornada/${num}/resumen-managers`);
            const data = await response.json();
            const container = document.getElementById('lista-contenido');

            if (!data || data.length === 0) {
                container.innerHTML = '<p style="text-align:center;">Sin datos de m√°nagers.</p>';
                return;
            }

            container.innerHTML = data.map(m => {
                let htmlJugadores = m.jugadores.map(j => {
                    let colorClass = 'text-orange';
                    if (j.puntos > 0) colorClass = 'text-green';
                    if (j.puntos < 0) colorClass = 'text-red';
                    return `
                    <div class="player-row">
                        <span>${j.nombre} <small>(${j.posicion.substring(0,3)})</small></span>
                        <span class="${colorClass}">${j.puntos}</span>
                    </div>`;
                }).join('');

                return `
                <div class="manager-card">
                    <div class="manager-header">
                        <span>${m.manager}</span>
                        <span class="pts-badge">${m.puntosTotal} pts</span>
                    </div>
                    <div>${htmlJugadores}</div>
                </div>`;
            }).join('');

        } catch (e) { console.error(e); }
    }

    function renderEquipo(elementId, jugadores, color) {
        const container = document.getElementById(elementId);
        container.innerHTML = "";

        const lineas = { PORTERO: [], DEFENSA: [], MEDIO: [], DELANTERO: [] };
        jugadores.forEach(j => {
            if(lineas[j.posicion]) lineas[j.posicion].push(j);
            else if(lineas.MEDIO) lineas.MEDIO.push(j);
        });

        const orden = ["PORTERO", "DEFENSA", "MEDIO", "DELANTERO"];

        orden.forEach(pos => {
            if (lineas[pos].length > 0) {
                const fila = document.createElement("div");
                fila.className = "linea-jugadores";
                lineas[pos].forEach(jug => {
                    let imgUrl = jug.imagen && jug.imagen.startsWith('/') ? jug.imagen : '/icon.png';
                    if(jug.imagen && jug.imagen.startsWith('http')) imgUrl = jug.imagen;

                    let badgeClass = 'badge-orange';
                    if(jug.puntos > 0) badgeClass = 'badge-green';
                    if(jug.puntos < 0) badgeClass = 'badge-red';

                    // Corona si es MVP
                    let crownHtml = jug.mvp ? '<div class="mvp-crown">üëë</div>' : '';

                    fila.innerHTML += `
                        <div class="jugador-card camiseta-${color} ${jug.mvp ? 'mvp' : ''}">
                            ${crownHtml}
                            <div class="puntos-badge ${badgeClass}">${jug.puntos}</div>
                            <img src="${imgUrl}" class="jugador-img">
                            <div class="jugador-nombre">${jug.nombre}</div>
                        </div>
                    `;
                });
                container.appendChild(fila);
            }
        });
    }

    function getColorCode(nombreColor) {
        if(!nombreColor) return '#fff';
        switch(nombreColor.toUpperCase()) {
            case 'ROJO': return '#ff5252';
            case 'AZUL': return '#448aff';
            case 'AMARILLO': return '#ffd740';
            case 'BLANCO': return '#ffffff';
            default: return '#fff';
        }
    }

    window.onload = () => {
        cargarTodo();
    };
</script>
</body>
</html>